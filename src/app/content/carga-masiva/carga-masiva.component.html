<div class="container-fluid p-4">

	<header class="bg-light border-bottom">
		<div class="container py-4 px-3">
			<div class="d-flex justify-content-between align-items-center">
				<div class="d-flex align-items-center gap-3">
					<div class="p-2 bg-primary rounded">
						<i class="fas fa-upload text-white fs-4"></i>
					</div>
					<div class="text-left">
						<h1 class="fw-bold text-dark mb-1 px-0">Carga Masiva</h1>
						<p class="text-muted mb-0">Enrolamiento masivo de personal</p>
					</div>
				</div>
			</div>
		</div>
	</header>

	<div class="container-fluid mt-4 p-3 bg-gray rounded-3 border-4">
		
		<!-- Sección de carga de archivo -->
		<div class="card mb-4" *ngIf="registros.length === 0">
			<div class="card-body text-center py-5">
				<i class="fas fa-file-excel text-secondary" style="font-size: 4rem;"></i>
				<h4 class="mt-3 mb-3">Cargar archivo Excel</h4>
				<p class="text-muted mb-4">Selecciona un archivo Excel para previsualizar los registros.</p>
				
				<div class="d-flex justify-content-center align-items-center gap-3">
					<input type="file" 
						   #fileInput 
						   (change)="onFileSelected($event)" 
						   accept=".xlsx,.xls" 
						   class="d-none" />
					<button class="btn btn-primary btn-lg" 
							(click)="fileInput.click()" 
							[disabled]="cargando">
						<i class="fas fa-file-upload me-2"></i>
						Seleccionar archivo
					</button>
				</div>
				
				<div *ngIf="cargando" class="mt-4">
					<div class="spinner-border text-primary" role="status">
						<span class="visually-hidden">Cargando...</span>
					</div>
					<p class="text-muted mt-2">Generando vista previa...</p>
				</div>
			</div>
		</div>

		<!-- Sección de previsualización -->
		<div *ngIf="registros.length > 0">
			
			<!-- Badge de total de registros -->
			<div class="mb-3">
				<span class="badge bg-primary fs-6 px-3 py-2">
					<i class="fas fa-database me-2"></i>
					Total de registros: {{ totalRegistros }}
				</span>
			</div>
			
			<!-- Barra de acciones -->
			<div class="d-flex justify-content-between align-items-center w-100 mb-3">
				<div class="w-80">
					<input type="text" 
						   placeholder="Buscar por cualquier campo" 
						   [(ngModel)]="searchTerm"
						   (input)="applyFilter()" 
						   class="form-control" />
				</div>
				<div class="d-flex gap-2">
					<button class="btn btn-outline-secondary" (click)="cancelarCarga()">
						<i class="fas fa-times me-2"></i>
						Cancelar
					</button>
					<button class="btn btn-success" 
							(click)="subirRegistros()" 
							[disabled]="subiendoRegistros">
						<i class="fas fa-check me-2" *ngIf="!subiendoRegistros"></i>
						<span class="spinner-border spinner-border-sm me-2" *ngIf="subiendoRegistros"></span>
						{{ subiendoRegistros ? 'Subiendo...' : 'Subir Registros' }}
					</button>
				</div>
			</div>
			
			<!-- Tabla de registros -->
			<div class="col-md-12 right align-items-right">

				<table class="w-100 table-responsive table-border-colapse">
					<thead>
						<tr>
							<td> Num Empleado </td>
							<td> RFC </td>
							<td> CURP </td>
							<td> Nombres </td>
							<td> Apellido Paterno </td>
							<td> Apellido Materno </td>
							<td> Adscripción </td>
							<td> Puesto </td>
							<td> Inicio Vig. </td>
							<td> Fin Vig. </td>
							<td> Eladia </td>
							<td> Foto </td>
						</tr>
					</thead>
					<tbody *ngIf="paginaRegistros.length > 0; else noData">

						<tr *ngFor="let registro of paginaRegistros">
							<td>
								<span *ngIf="registro.num_empleado">{{ registro.num_empleado }}</span>
								<span *ngIf="!registro.num_empleado" class="text-danger small">Sin número</span>
							</td>
							<td>{{ registro.rfc }}</td>
							<td>{{ registro.curp }}</td>
							<td>{{ registro.nombre }}</td>
							<td>{{ registro.paterno }}</td>
							<td>{{ registro.materno }}</td>
							<td>{{ registro.adscripcion || 'N/A' }}</td>
							<td>{{ registro.puesto || 'N/A' }}</td>
							<td>{{ formatearFecha(registro.inicio_vig) }}</td>
							<td>{{ formatearFecha(registro.fin_vig) }}</td>
							<td>{{ registro.eladia || 'N/A' }}</td>
							<td class="text-center">
								<i *ngIf="registro.foto" class="fas fa-check-circle text-success"></i>
								<i *ngIf="!registro.foto" class="fas fa-times-circle text-danger"></i>
							</td>
						</tr>

					</tbody>

					<ng-template #noData>
						<tbody>
							<tr>
								<td colspan="12" class="text-center py-4 text-muted">
									<i class="fas fa-info-circle me-2"></i>
									No hay registros disponibles.
								</td>
							</tr>
						</tbody>
					</ng-template>
				</table>

				<div class="text-end my-2" *ngIf="registros.length > 0">
					Mostrando del
					<strong>{{ currentPage * pageSize + 1 }} </strong>
					al
					<strong>{{ Math.min((currentPage + 1) * pageSize, filteredRegistros.length) }} </strong>
					de <strong>{{ filteredRegistros.length }}</strong> registros
				</div>
				<div class="pagination">
					<button (click)="prevPage()" [disabled]="currentPage === 0">
						<i class="fas fa-caret-left"></i>
					</button>

					<ng-container *ngIf="visiblePages[0] > 0">
						<span>...</span>
					</ng-container>

					<ng-container *ngFor="let page of visiblePages">
						<button (click)="goToPage(page)" [class.active]="page === currentPage">
							{{ page + 1 }}
						</button>
					</ng-container>

					<ng-container *ngIf="visiblePages[visiblePages.length - 1] < totalPages - 1">
						<span>...</span>
					</ng-container>

					<button (click)="nextPage()" [disabled]="currentPage === totalPages - 1">
						<i class="fas fa-caret-right"></i>
					</button>
				</div>
			</div>

		</div>

	</div>

</div>

<!-- Modal de confirmación -->
<ng-template #modalConfirmacion>
	<div class="modal-body text-center py-4">
		<i class="fas fa-exclamation-triangle text-secondary" style="font-size: 3rem;"></i>
		<h4 class="mt-3 mb-3">Confirmación de carga</h4>
		<p class="text-muted">¿Estás seguro de que la información es correcta?</p>
		<p class="fw-bold">Se subirán {{ totalRegistros }} registros a la base de datos.</p>
	</div>
</ng-template>

<!-- Modal de duplicados -->
<ng-template #modalDuplicados>
	<div class="modal-body">
		<div class="alert alert-danger mb-3">
			<i class="fas fa-exclamation-circle me-2"></i>
			<strong>{{ errorResponse?.mensaje }}</strong>
		</div>
		
		<div *ngIf="errorResponse?.resumen" class="mb-3">
			<h6 class="fw-bold mb-2">Resumen:</h6>
			<ul class="list-unstyled">
				<li><strong>Total de registros:</strong> {{ errorResponse.resumen.total_registros }}</li>
				<li><strong>Registros válidos:</strong> {{ errorResponse.resumen.registros_validos }}</li>
				<li class="text-danger"><strong>Registros duplicados:</strong> {{ errorResponse.resumen.registros_duplicados }}</li>
			</ul>
		</div>
		
		<div *ngIf="errorResponse?.lista_duplicados && errorResponse.lista_duplicados.length > 0">
			<h6 class="fw-bold mb-2">Lista de duplicados:</h6>
			<div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
				<table class="table table-sm table-striped">
					<thead class="sticky-top bg-white">
						<tr>
							<th>CURP</th>
							<th>Nombre</th>
							<th>Apellido Paterno</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngFor="let duplicado of errorResponse.lista_duplicados">
							<td>{{ duplicado.curp }}</td>
							<td>{{ duplicado.nombre }}</td>
							<td>{{ duplicado.paterno }}</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
		
		<div class="text-center mt-3">
			<button class="btn btn-primary" (click)="cerrarModalDuplicados()">
				<i class="fas fa-times me-2"></i>
				Cerrar
			</button>
		</div>
	</div>
</ng-template>
