<div class="container-fluid p-4">

    <header class="bg-light border-bottom">
        <div class="container py-4 px-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <div class="p-2 bg-primary rounded">
                        <!-- Icono de archivo (puedes usar Bootstrap Icons o Font Awesome) -->
                        <i class="fas fa-chart-gantt text-white fs-4"></i>
                    </div>
                    <div class="">
                        <h1 class="fw-bold text-dark mb-1">Reportes</h1>
                        <p class="text-muted mb-0">Reportes y estadísticas de registro de asuntos</p>
                    </div>
                </div>

                <div class="d-flex align-items-center gap-2 text-muted small">
                    <i class="bi bi-calendar"></i>
                    <span>Última actualización: Hoy</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Filtros de Fecha -->
    <div class="container mt-3 p-3 bg-gray rounded-3 border-4">
        <div class="bg-light border-bottom p-3">
            <h5 class="card-title d-flex align-items-center gap-2 mb-0">
                <i class="fas fa-filter text-primary"></i>
                <span class="h5">Filtros de Fecha</span>
            </h5>
            <span class="small text-muted">Rango de fecha de registro de asuntos. </span>
        </div>
        <!-- filtros -->
        <div class="pt-2">
            <form class="row gy-3 gx-4 align-items-end">
                <div class="col-12 col-sm-4">
                    <label for="start-date" class="form-label fw-medium ">Fecha de inicio</label>
                    <input id="start-date" type="date" class="form-control" [(ngModel)]="startDate" name="startDate" />
                </div>

                <div class="col-12 col-sm-4">
                    <label for="end-date" class="form-label fw-medium ">Fecha de Fin</label>
                    <input id="end-date" type="date" class="form-control" [(ngModel)]="endDate" name="endDate" />
                </div>

                <div class="col-md-4 d-flex justify-content-center gap-2">
                    <button type="button" class="btn btn-primary d-flex align-items-center gap-2"
                        (click)="applyFilter()" [disabled]="cargando">
                        <i class="fas fa-calendar px-2"></i>
                        <span>Aplicar</span>
                    </button>

                    <button type="button" class="btn btn-outline-secondary" (click)="clearFilter()"
                        [disabled]="cargando">
                        <i class="fas fa-filter px-2"></i>
                        Limpiar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contenido del componente reporte -->
    <div class="container" *ngIf="!cargando && reporteCargado">

    <!-- Dataset 1 y 2: Cards de estadísticas principales -->
    <div class="charts-section">
        <div class="container w-100 p-0 gap-3 d-flex flex-wrap justify-content-start">
        <!-- Total de asuntos -->
        <div class="card-ld-stats bg-gray rounded-3 border-4 d-flex flex-column align-content-around">
            <div class="d-flex justify-content-between align-items-center mb-2 flex-fill"> 
                <h3>Total de asuntos</h3> 
                <span> <i class="fa-regular fa-file-lines fa-2x text-deep-blue"></i></span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="display-4 fw-bold text-deep-blue">{{ totalAsuntos }}</h3>
            </div>
            <div>
                <span class="text-muted small">Total de asuntos en el periodo</span>
            </div>
        </div>

        <!-- Cards con ngFor para carga dinamica. (datasets 1 y 2) -->
        <div *ngFor="let status of asuntosPorStatus" 
             class="card-ld-stats bg-gray rounded-3 border-4 d-flex flex-column align-content-around">
            <div class="d-flex justify-content-between align-items-center mb-2 flex-fill"> 
                <h3>{{ status.statusAsunto }}</h3> 
                <span>
                    <i class="fa-regular fa-2x" 
                       [ngClass]="{
                           'fa-circle-right text-deep-blue': status.idStatusAsunto === 1,
                           'fa-clock text-gold': status.idStatusAsunto === 2,
                           'fa-circle-check text-success': status.idStatusAsunto === 3
                       }"></i>
                </span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="display-4 fw-bold text-deep-blue">{{ status.totalPorStatus }}</h3>
                <span class="text-muted d-flex align-items-center gap-1">
                    {{ status.porcentaje }}%
                </span>

            </div>
            <div>
                <span class="text-muted small">{{ status.statusAsunto }} en el periodo</span>
            </div>
        </div>
        </div>
    </div>

    <!-- Dataset 2: Asuntos por Status - Gráficas circulares -->
    <div class="charts-section" *ngIf="asuntosPorStatus && asuntosPorStatus.length > 0">
        <div class="section-title">
            <i class="fas fa-chart-pie text-secondary me-2"></i>
            Distribución de Asuntos por Status
        </div>
        <div class="charts-grid">
            <div class="chart-card" *ngFor="let status of asuntosPorStatus">
                <div class="chart-card-header">
                    <h5>{{ status.statusAsunto }}</h5>
                </div>
                <div class="chart-card-body">
                    <div class="percentage-circle">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg"
                                d="M18 2.0845
                                a 15.9155 15.9155 0 0 1 0 31.831
                                a 15.9155 15.9155 0 0 1 0 -31.831"
                            />
                            <path class="circle"
                                [attr.stroke-dasharray]="status.porcentaje + ', 100'"
                                [attr.stroke]="status.idStatusAsunto === 1 ? '#003366' : 
                                             status.idStatusAsunto === 2 ? '#C9A977' : '#007B5D'"
                                d="M18 2.0845
                                a 15.9155 15.9155 0 0 1 0 31.831
                                a 15.9155 15.9155 0 0 1 0 -31.831"
                            />
                            <text x="18" y="20.35" class="percentage">{{ status.porcentaje }}%</text>
                        </svg>
                    </div>
                    <div class="chart-card-total">
                        <i class="fas fa-file-alt me-2"></i>
                        {{ status.totalPorStatus }} asunto{{ status.totalPorStatus !== 1 ? 's' : '' }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tiempo Promedio de Atención (dataset 3) -->
    <div class="charts-section" *ngIf="tiempoPromedioAtencion">
        <div class="section-title">
            <i class="fa-solid fa-clock text-secondary me-2"></i>
            Tiempo Promedio de Atención
        </div>
        <div class="stats-cards-container">
            <div class="stat-card" style="border-left-color: #C9A977;">
                <div class="stat-icon" style="background: #C9A977;">
                    <i class="fas fa-stopwatch"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Tiempo Promedio de Atención</div>
                    <div class="stat-value">{{ tiempoPromedioAtencion.tiempoPromedioAtencion }}</div>
                </div>
            </div>
            <div class="stat-card" style="border-left-color: #D4AF37;">
                <div class="stat-icon" style="background: #C9A977;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total Asuntos Concluidos</div>
                    <div class="stat-value">{{ tiempoPromedioAtencion.totalAsuntosConcluidos }}</div>
                </div>
            </div>
        </div>
    </div>

        <!-- Dataset 10 y 11: Gráficas de timeline en dos columnas -->
    <div class="charts-section">
        <div class="row g-3">
            <!-- Dataset 10: Porcentaje de asuntos por unidad respecto al total de asuntos turnados -->
            <div class="col-md-6">
                <div class="bg-light rounded-3 p-4 h-100">
                    <h5 class="mb-3">
                        <div class="section-title">
                        <i class="fa-solid fa-chart-bar text-secondary me-2"></i>
                        Asuntos por Unidad respecto al Total de Asuntos Turnados
                        </div>
                    </h5>
                    <div class="chart-container">
                        <div class="timeline-chart">
                            <div class="timeline-item" *ngFor="let unidad of asuntosPorUnidadRespTotalTurnados">
                                <div class="timeline-label">{{ unidad.area }}</div>
                                <div class="timeline-bar-wrapper">
                                    <div class="timeline-bar" 
                                         [style.width.%]="unidad.porcentajeSobreTotalAsuntos">
                                    </div>
                                </div>
                                <div class="timeline-value">
                                    {{ unidad.totalAsuntosAtendidos }}
                                    <small class="text-muted d-block">({{ unidad.porcentajeSobreTotalAsuntos }}%)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dataset 11: Porcentaje por Unidad respecto al Total de Unidades -->
            <div class="col-md-6">
                <div class="bg-light rounded-3 p-4 h-100">
                    <h5 class="mb-3">
                        <div class="section-title">
                        <i class="fa-solid fa-percent text-secondary me-2"></i>
                        Porcentaje por Unidad respecto al Total de Unidades Administrativas
                        </div>
                    </h5>
                    <div class="chart-container">
                        <div class="timeline-chart">
                            <div class="timeline-item" *ngFor="let unidad of asuntosPorUnidadRespTotalUnidades">
                                <div class="timeline-label">{{ unidad.area }}</div>
                                <div class="timeline-bar-wrapper">
                                    <div class="timeline-bar" 
                                         [style.width.%]="unidad.porcentajeRespectoTotalUnidades"
                                         style="background: linear-gradient(90deg, #C9A977, #8a3737 );">
                                    </div>
                                </div>
                                <div class="timeline-value">
                                    {{ unidad.totalAsuntosAsignados }}
                                    <small class="text-muted d-block">({{ unidad.porcentajeRespectoTotalUnidades.toFixed(2) }}%)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dataset 4 y 5: Tablas en dos columnas -->
    <div class="charts-section">
        <div class="row g-3">
            <!-- Lista detallada de asuntos concluidos (dataset 4) -->
            <div class="col-md-6">
                <div class="bg-light rounded-3 p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <div class="section-title">
                            <i class="fa-solid fa-list-check text-secondary me-2"></i>
                            Asuntos Concluidos - Detalle
                            </div>
                        </h5>
                        <!-- <button class="btn btn-sm btn-outline-secondary" (click)="exportarTabla('asuntosConcluidos')">
                            <i class="fa-solid fa-download"></i>
                        </button> -->
                    </div>
                    <div class="table-responsive no-scrollbar" style="overflow-y: auto; max-height: 80vh;" >
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>No. Oficio</th>
                                    <th>Fecha Recepción</th>
                                    <th>Fecha Conclusión</th>
                                    <th>Tiempo de Atención</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let asunto of asuntosConcluidos">
                                    <td class="fw-bold">{{ asunto.idAsunto }}</td>
                                    <td>{{ asunto.noOficio }}</td>
                                    <td>{{ asunto.fechaRecepcion | date:'short' }}</td>
                                    <td>{{ asunto.fechaConclusion | date:'short' }}</td>
                                    <td>
                                        <span class="badge badge-tiempo-atencion bg-gold text-white">{{ asunto.tiempoAtencion }}</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tiempo promedio por tema (dataset 5)-->
            <div class="col-md-6">
                <div class="bg-light rounded-3 p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <div class="section-title">
                            <i class="fa-regular fa-clock fa-lg text-secondary me-2"></i>
                            Tiempo Promedio de Atención por Tema
                            </div>
                        </h5>
                        <!-- <button class="btn btn-sm btn-outline-secondary" (click)="exportarTabla('tiempoPorTema')">
                            <i class="fa-solid fa-download"></i>
                        </button> -->
                    </div>
                    <div class="table-responsive no-scrollbar" style="overflow-y: auto; max-height: 80vh;" >
                        <table class="table table-striped table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Tema</th>
                                    <th class="text-center">Asuntos Concluidos</th>
                                    <th>Tiempo Promedio</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let tema of tiempoPorTema">
                                    <td class="fw-medium">{{ tema.Tema }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-deep-blue text-white">{{ tema.totalAsuntosConcluidos }}</span>
                                    </td>
                                    <td>
                                        <i class="fa-solid fa-clock text-muted me-2"></i>
                                        {{ tema.tiempoPromedioAtencion }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dataset 6: Asuntos por tema - Gráfica de barras horizontales -->
    <div class="charts-section" *ngIf="asuntosPorTema && asuntosPorTema.length > 0">
        <div class="section-title">
            <i class="fas fa-chart-bar text-secondary me-2"></i>
            Distribución de Asuntos por Tema
        </div>
        <div class="bg-light rounded-3 p-4">
            <div class="chart-item-wrapper" style="min-height: 500px;">
                <app-graficas
                    [chartID]="'grafica-asuntos-tema'"
                    [width]="'1200px'"
                    [height]="'500px'"
                    [type]="'bar'"
                    [indexAxis]="'y'"
                    [stepSize]="5"
                    [max]="50"
                    [datasets]="graficaAsuntosPorTema"
                    [compact]="false"
                    [showLegend]="false"
                    [showYAxisLabels]="true"
                    [showXAxisLabels]="true"
                    [showXAxis]="true"
                    [showYAxis]="true"
                    [customTooltip]="true"
                    [tooltipData]="tooltipAsuntosPorTema">
                </app-graficas>
            </div>
        </div>
    </div>

    <!-- Dataset 7: Turnos por Unidad - Gráfica de barras horizontales (ancho completo) -->
    <div class="charts-section" *ngIf="turnosPorUnidad && turnosPorUnidad.length > 0">
        <div class="section-title">
            <i class="fas fa-chart-bar text-secondary me-2"></i>
            Turnados por Unidad Responsable
        </div>
        <div class="bg-light rounded-3 p-4">
            <div class="chart-item-wrapper" style="min-height: 400px;">
                <app-graficas
                    [chartID]="'grafica-turnos-unidad'"
                    [width]="'1200px'"
                    [height]="'400px'"
                    [type]="'bar'"
                    [indexAxis]="'y'"
                    [stepSize]="5"
                    [max]="50"
                    [datasets]="graficaTurnosPorUnidad"
                    [compact]="false"
                    [showLegend]="false"
                    [showYAxisLabels]="true"
                    [showXAxisLabels]="true"
                    [showXAxis]="true"
                    [showYAxis]="true"
                    [customTooltip]="false"
                    [tooltipData]="tooltipTurnosPorUnidad">
                </app-graficas>
            </div>
        </div>
    </div>

    <!-- Dataset 8: Asuntos distintos por unidad - Tabla -->
    <div class="charts-section" *ngIf="listaAsuntosPorUnidad && listaAsuntosPorUnidad.length > 0">
        <div class="section-title">
            <div class="section-title">
            <i class="fas fa-list-ol text-secondary me-2 "></i>
            Asuntos por Unidad Administrativa
            </div>
        </div>
        <div class="bg-light rounded-3 p-4">
            <div class="table-responsive" style="overflow-y: auto; max-height: 45vh;">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Unidad Administrativa</th>
                            <th class="text-center">Total Asuntos</th>
                            <th class="text-center">Porcentaje</th>
                            <th>IDs</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let unidad of listaAsuntosPorUnidad">
                            <td class="fw-bold">{{ unidad.area }}</td>
                            <td class="text-center">
                                <span class="badge bg-secondary">{{ unidad.totalAsuntosAtendidos }}</span>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-porcentaje">{{ unidad.porcentajeSobreTotalAsuntosTurnados }}%</span>
                            </td>
                            <td>
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge bg-secondary" *ngFor="let id of unidad.listaIdAsuntos.split(', ')">
                                         {{ id }}
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Dataset 9: Asuntos con lista de unidades responsables -->
    <div class="charts-section">
        <div class="p-0">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">
                    <div class="section-title">
                    <i class="fa-solid fa-sitemap text-secondary me-2"></i>
                    Asuntos y sus Unidades Responsables
                    </div>
                </h3>
                
            </div>
            <div class="table-responsive" style="overflow-y: auto; max-height: 45vh;">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID Asunto</th>
                            <th>No. Oficio</th>
                            <th>Unidades Responsables</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let asunto of asuntosConUnidades">
                            <td class="fw-bold">{{ asunto.idAsunto }}</td>
                            <td>{{ asunto.noOficio }}</td>
                            <td>
                                <span class="badge bg-secondary me-1" 
                                      *ngFor="let unidad of asunto.unidadesResponsables.split(', ')">
                                    {{ unidad }}
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    </div>
</div>